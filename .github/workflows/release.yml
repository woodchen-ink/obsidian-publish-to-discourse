name: Release Obsidian plugin

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Build plugin
        run: |
          npm install
          npm run build

      - name: Generate release notes
        id: release_notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${GITHUB_REF#refs/tags/}"
          
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          previous_tag=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          if [ -n "$previous_tag" ]; then
            echo "## ğŸš€ æ›´æ–°å†…å®¹ / What's Changed" > release_notes.md
            echo "" >> release_notes.md
            
            # åˆ†ææäº¤ç±»å‹å¹¶åˆ†ç±»æ˜¾ç¤º
            echo "### âœ¨ æ–°å¢åŠŸèƒ½ / New Features:" >> release_notes.md
            git log --pretty=format:"%s" "$previous_tag"..HEAD | grep -i "^feat\|^add\|^æ–°å¢\|^åŠŸèƒ½" | sed 's/^/- /' >> release_notes.md || echo "- æš‚æ— " >> release_notes.md
            echo "" >> release_notes.md
            
            echo "### ğŸ› é—®é¢˜ä¿®å¤ / Bug Fixes:" >> release_notes.md
            git log --pretty=format:"%s" "$previous_tag"..HEAD | grep -i "^fix\|^bug\|^ä¿®å¤\|^ä¿®æ­£" | sed 's/^/- /' >> release_notes.md || echo "- æš‚æ— " >> release_notes.md
            echo "" >> release_notes.md
            
            echo "### ğŸ”§ æ”¹è¿›ä¼˜åŒ– / Improvements:" >> release_notes.md
            git log --pretty=format:"%s" "$previous_tag"..HEAD | grep -i "^improve\|^update\|^ä¼˜åŒ–\|^æ”¹è¿›\|^æ›´æ–°" | sed 's/^/- /' >> release_notes.md || echo "- æš‚æ— " >> release_notes.md
            echo "" >> release_notes.md
            
            echo "### ğŸ“ æ‰€æœ‰æäº¤ / All Commits:" >> release_notes.md
            git log --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" "$previous_tag"..HEAD >> release_notes.md
            echo "" >> release_notes.md
            
            echo "### ğŸ“‚ å˜æ›´æ–‡ä»¶ / Changed Files:" >> release_notes.md
            git diff --name-only "$previous_tag"..HEAD | sed 's/^/- `/' | sed 's/$/`/' >> release_notes.md
            
            echo "" >> release_notes.md
            echo "---" >> release_notes.md
            echo "**å®Œæ•´å˜æ›´æ—¥å¿—**: https://github.com/${{ github.repository }}/compare/$previous_tag...$tag" >> release_notes.md
          else
            # é¦–æ¬¡å‘å¸ƒæ—¶ä½¿ç”¨ GitHub è‡ªåŠ¨ç”Ÿæˆçš„å‘å¸ƒè¯´æ˜
            echo "" > release_notes.md
          fi

      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${GITHUB_REF#refs/tags/}"
          previous_tag=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          files=()
          for file in main.js manifest.json styles.css; do
            if [ -f "$file" ]; then
              files+=("$file")
            else
              echo "Warning: $file not found"
              exit 1
            fi
          done

          if [ -n "$previous_tag" ]; then
            # æœ‰ä¸Šä¸€ä¸ªæ ‡ç­¾ï¼Œä½¿ç”¨è‡ªå®šä¹‰å‘å¸ƒè¯´æ˜
            gh release create "$tag" \
              --title="Release $tag" \
              --notes-file release_notes.md \
              "${files[@]}"
          else
            # é¦–æ¬¡å‘å¸ƒï¼Œä½¿ç”¨ GitHub è‡ªåŠ¨ç”Ÿæˆçš„å‘å¸ƒè¯´æ˜
            gh release create "$tag" \
              --title="Release $tag" \
              --generate-notes \
              "${files[@]}"
          fi
